#include <string>
#include <filesystem>

#include "Scanner.h"
#include "Server_un.h"

#define BUFLEN 1024

int main(int argc, char** argv) {
    
    try {
        
        Server_un server("/tmp/a.sock");
        std::cout << "== Scan service is started ==\n";
        Scanner scanner;

        while (true) {
            server.accept();
            std::string dir_path = server.recv();

            if (dir_path == "quit") {
                std::cout << "got: quit\n" << "=========================\n";
                std::string finish = "scan_service finished the work\n";
                server.send(finish);
                server.disconnect();
                return 0;
            }

            if (!std::filesystem::is_directory(dir_path)) {
                std::cerr << "\"" << dir_path << "\" is not a directory\n";
                continue;
            }

            std::cout << "Scanning: " << dir_path << std::endl;
            scanner.scan_dir(dir_path);
            server.send(scanner.print_results());
            std::cout << "Results have been sent\n";

            server.disconnect();
            scanner.reset();
        }
    }
    catch (char *str) {
        std::cout << str;
    }
}


